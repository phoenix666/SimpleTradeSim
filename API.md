# API модулей

## db.js (IndexedDB)

- `openDB()` - Открывает/создает базу данных IndexedDB. Возвращает Promise.
- `clearCandles()` - Очищает все записи в хранилище свечей. Возвращает Promise.
- `addCandles(candles, onProgress)` - Добавляет массив свечей в БД. `candles` - массив объектов {open, high, low, close}. `onProgress` - опциональный коллбэк (done, total) для отображения прогресса. Возвращает Promise.
- `getAllCandles()` - Получает все свечи из БД. Возвращает Promise с массивом свечей.
- `getCandleRange(start, count)` - Получает свечи с позиции `start` в количестве `count`. Возвращает Promise с массивом.
- `getCandleCount()` - Возвращает общее количество свечей в БД. Возвращает Promise с числом.

## parser.js (Парсинг файлов)

- `detectDelimiter(lines)` - Определяет разделитель в файле (;, ,, :, пробел, таб). `lines` - массив строк. Возвращает символ-разделитель.
- `parseValue(str)` - Парсит строку в число. Меняет запятую на точку. Возвращает число или null.
- `isValidOHLC(cols)` - Проверяет валидность значений OHLC (open, high, low, close). `cols` - массив из 4 значений. Возвращает boolean.
- `findOHLCColumns(rows, delimiter)` - Ищет индекс колонки, с которой начинаются 4 последовательные колонки с валидными OHLC. `rows` - массив строк, `delimiter` - разделитель. Возвращает индекс или -1.
- `loadCandles(file)` - Загружает свечи из файла. `file` - объект File из input. Асинхронная, вызывает `onCandlesLoaded(count)` после загрузки. Показывает прогресс "Loading... X%" во время загрузки. Выводит ошибки в toast и консоль.
- `showToast(message)` - Показывает всплывающее сообщение (красный toast сверху по центру). Сообщение исчезает через 5 секунд или при клике.

## chart.js (Отрисовка графика)

- `resizeCanvas()` - Изменяет размер canvas под контейнер и перерисовывает график.
- `getPriceRange(startIndex)` - Вычисляет мин/макс цены для видимых свечей. `startIndex` - конечный индекс. Возвращает {min, max}.
- `priceToY(price, range)` - Конвертирует цену в Y-координату на canvas. Возвращает число.
- `yToPrice(y, range)` - Конвертирует Y-координату в цену. Обратная к priceToY. Возвращает число.
- `countDecimalDigits(num)` - Считает количество знаков после запятой. Возвращает число.
- `formatPrice(value, num)` - Форматирует число в строку с `num` знаками после запятой (дополняет нулями). Возвращает строку.
- `render()` - Основная функция отрисовки графика на canvas. Включает отрисовку линий stopLoss (красная пунктирная) и profitLimit (зеленая пунктирная). Значения отображаются на линиях в последней трети графика.
- `loadAndRender()` - Загружает свечи из БД и рендерит график. Асинхронная. Показывает индикатор "Preparing data..." во время загрузки.
- `onCandlesLoaded(count)` - Коллбэк, вызывается после загрузки свечей. Перезапускает `loadAndRender()`, обновляет состояние кнопок через `updateButtonState()` и торговый дисплей.
- `setStopLimit(stop, limit)` - Устанавливает значения stopLoss и profitLimit. `stop` - цена стоп-лосса, `limit` - цена тейк-профита. После установки перерисовывает график.
- `clearStopLimit()` - Сбрасывает значения stopLoss и profitLimit в 0.
- `findMeaningfulDigits()` - Вычисляет оптимальное количество знаков после запятой для отображения цен на основе анализа выборки свечей. Результат записывается в глобальную переменную `maxDecimalDigits`. Вызывается один раз при загрузке свечей.
- Интерактивное перетаскивание: линии stopLoss и profitLimit можно перетаскивать мышью. При наведении курсор меняется на `ns-resize`. Линии автоматически учитываются в масштабе графика.

## app.js (Приложение)

- `updateTradingDisplay()` - Обновляет отображение CashBalance, CurrentPosition и UnrealizedGain на странице. CurrentPosition окрашивается: положительный - светло-зеленый, отрицательный - светло-красный.
- `getMaxHlRange()` - Вычисляет максимальный диапазон high-low среди видимых свечей. Возвращает число.
- `initStopLimit(isLong)` - Инициализирует stopLoss и profitLimit на основе текущей цены и волатильности. `isLong` - true для длинной позиции, false для короткой. Использует #useSl чекбокс.
- `validatePositionSize()` - Проверяет, что PositionSize не превышает 0.8 * CashBalance * Leverage. Если превышает - корректирует в меньшую сторону.
- `increasePosition(marginSize, positionSize)` - Увеличивает позицию: вычитает маржу из cashBalance, добавляет amount к currentPosition, обновляет positionMargin и positionCostBasis. Логирует операцию.
- `closePosition(partSize)` - Закрывает позицию полностью или частично. При закрытии возвращает маржу + PnL в cashBalance, сбрасывает stopLoss и profitLimit в 0. Логирует операцию с размером закрытия и PnL.
- `checkStopLimitClose(newCandle, oldClose)` - Проверяет, достигла ли цена стопа или лимита при переходе к новой свече. `newCandle` - объект {open, high, low, close} новой свечи, `oldClose` - цена закрытия предыдущей свечи. Определяет, что было первым (high или low), проверяет диапазоны. При срабатывании стопа/лимита рассчитывает unrealizedGain и вызывает closePosition(). Возвращает true если закрытие произошло.
- `logOperation(action, amount, pnl)` - Записывает операцию в лог. `action` - тип операции (Long/Short/Close/Partial close), `amount` - количество актива, `pnl` - финансовый результат (0 если позиция только открыта). PnL окрашивается: прибыль - зеленый, убыток - красный.
- `updateButtonState()` - Обновляет состояние кнопки "Очистить базу" (disabled если свечей нет). Возвращает количество свечей.
- `calculateSpread()` - Пересчитывает spreadValue на основе последних 20 видимых свечей. Формула: среднее(high - low) * 0.05. Если чекбокс #emulateSpread не отмечен - устанавливает spreadValue = 0.
- `adjustPositionSize(direction)` - Изменяет positionSize на старший разряд. `direction` > 0 увеличивает, < 0 уменьшает. При уменьшении ниже 1 переходит к старшему разряду минус 1 (например 1000 → 900).
- `init()` - Инициализация приложения: открывает БД, обновляет состояние кнопок, загружает данные, восстанавливает настройки из localStorage.
- `loadSettings()` - Восстанавливает состояние чекбоксов useSl, emulateSpread и селектора leverage из localStorage. Вызывает calculateSpread().
- `saveSettings()` - Сохраняет состояние чекбоксов useSl, emulateSpread и селектора leverage в localStorage. Вызывается при изменении элементов и при beforeunload.
- Обработчики событий:
  - `fileInput.change` - Запускает загрузку свечей при выборе файла.
  - `clearBtn.click` - Очищает базу и сбрасывает график.
  - `randomBtn.click` - Устанавливает случайный lastIndex, сбрасывает торговые переменные в начальные значения, очищает stopLoss/profitLimit и пересчитывает spread.
  - `stepForwardBtn.click` - Увеличивает lastIndex на 1, пересчитывает позицию пропорционально изменению цены. При наличии стопа/лимита проверяет их срабатывание через checkStopLimitClose. Пересчитывает spread.
  - `leverageSelect.change` - Обновляет leverage и валидирует PositionSize.
  - `positionSizeInput.input` - Обновляет positionSize и валидирует его.
  - `positionSizeInput.keydown` - При нажатии ArrowUp/ArrowDown меняет значение на старший разряд.
  - `posSizeUp.click` - Увеличивает positionSize на старший разряд.
  - `posSizeDown.click` - Уменьшает positionSize на старший разряд.
  - `useSl.change` - При снятии галочки сбрасывает stopLoss/profitLimit и очищает линии на графике.
  - `emulateSpread.change` - Пересчитывает spread при изменении чекбокса.
  - `buyBtn.click` - Если позиции нет - открывает длинную (long). Если есть короткая - закрывает её.
  - `sellBtn.click` - Если позиции нет - открывает короткую (short). Если есть длинная - закрывает её.
  - `closeHalfBtn.click` - Закрывает 50% текущей позиции.
  - `hotkeySettingsBtn.click` - Открывает модальное окно настроек горячих клавиш.

## Глобальные переменные

### chart.js
- `candles` - Массив всех загруженных свечей.
- `lastIndex` - Индекс последней отображаемой свечи (конец диапазона).
- `stopLoss` - Уровень стоп-лосса (0 если не установлен).
- `profitLimit` - Уровень тейк-профита (0 если не установлен).
- `draggingLine` - Текущая перетаскиваемая линия ('stop' | 'limit' | null).
- `currentRange` - Текущий диапазон цен {min, max} для отрисовки.
- `maxDecimalDigits` - Максимальное количество знаков после запятой для цен (вычисляется один раз при загрузке свечей).
- `DRAG_THRESHOLD` - Расстояние в пикселях для захвата линии (10).
- `CANDLE_COUNT` - Количество видимых свечей на графике (20).
- `RIGHT_MARGIN` - Отступ справа (0.1).
- `GRID_LINES` - Количество линий сетки (10).

### app.js
- `cashBalance` - Текущий доступный баланс (начальное значение 10000).
- `leverage` - Кредитное плечо (10, 20, 50 или 100). По умолчанию 20.
- `positionSize` - Размер позиции, которую хочет открыть пользователь.
- `currentPosition` - Текущий размер открытой позиции в единицах актива (может быть отрицательным для short).
- `positionCostBasis` - Сумма всех "вложений" в позицию по цене открытия.
- `positionMargin` - Сколько реально зарезервировано кэша из CashBalance под позицию.
- `unrealizedGain` - Нереализованная прибыль или убыток.
- `spreadValue` - Значение спреда для эмуляции (0 если #emulateSpread не отмечен).
- `slClose` - Цена закрытия по стопу или лимиту для записи в лог.
- `MAX_LOG_ENTRIES` - Максимальное количество записей в логе операций (20).
- `lastLogCount` - Счетчик повторяющихся операций для группировки ( *N ).
- `lastLogEntry` - Хранит HTML последней записи для сравнения.
- `stopLoss` - Уровень стоп-лосса для текущей позиции.
- `profitLimit` - Уровень тейк-профита для текущей позиции.

## CSS классы

- `.positive` - Ярко-зеленый цвет для положительного unrealizedGain.
- `.negative` - Ярко-красный цвет для отрицательного unrealizedGain.
- `.pos-light` - Светло-зеленый для положительного currentPosition.
- `.neg-light` - Светло-красный для отрицательного currentPosition и убытка в логе.
- `.col-action` - Колонка действия в логе (Buy/Sell/Close).
- `.col-amount` - Колонка количества в логе.
- `.col-price` - Колонка цены в логе.
- `.col-pnl` - Колонка PnL в логе.
- `.col-count` - Колонка счетчика повторов ( *N ) в логе.

## HTML элементы

- `#log` - Контейнер для отображения лога операций (последние 10).
- `#useSl` - Чекбокс для включения автоматического расчета stopLoss и profitLimit при открытии позиции.
- `#emulateSpread` - Чекбокс для включения эмуляции спреда.
- `#loading` - Оверлей с индикатором загрузки (spinner + текст). Показывается при загрузке файла и при открытии страницы с данными.
- `#loading-text` - Текст внутри индикатора загрузки.
- `#toast` - Всплывающее сообщение об ошибке. Красный прямоугольник сверху по центру.
- `#posSizeUp`, `#posSizeDown` - Кнопки для изменения positionSize на старший разряд.
- `#hotkeySettingsBtn` - Кнопка для открытия модального окна настроек горячих клавиш.

## hotkeys.js (Горячие клавиши)

- `defaultHotkeys` - Объект с горячими клавишами по умолчанию:
  - `buy`: 'a' - Buy (Long)
  - `sell`: 's' - Sell (Short)
  - `close`: 'z' - Полное закрытие позиции
  - `stepForward`: 'f' - Step Forward
  - `limitUp`: 'l' - Поднять Limit
  - `limitDown`: ',' - Опустить Limit
  - `stopUp`: ';' - Поднять Stop
  - `stopDown`: '.' - Опустить Stop
  - `settings`: 'h' - Открыть настройки
- `loadHotkeys()` - Загружает горячие клавиши из localStorage. При отсутствии использует defaults.
- `saveSettings()` - Сохраняет текущие горячие клавиши в localStorage.
- `getStepSize()` - Вычисляет шаг изменения цены для стопа/лимита (1% от текущего диапазона цен на графике).
- `moveStop(direction)` - Перемещает stopLoss на шаг вверх (direction > 0) или вниз (direction < 0).
- `moveLimit(direction)` - Перемещает profitLimit на шаг вверх (direction > 0) или вниз (direction < 0).
- `closeFullPosition()` - Полностью закрывает текущую позицию.
- `handleHotkey(e)` - Обрабатывает нажатия клавиш. Игнорирует ввод в INPUT/SELECT/TEXTAREA.
- `toggleSettingsModal()` - Показывает/скрывает модальное окно настроек горячих клавиш.
- `createSettingsModal()` - Создает модальное окно с настройками (создается один раз).
- `renderHotkeyInputs()` - Обновляет поля ввода в модальном окне текущими значениями горячих клавиш.
- `initHotkeys()` - Инициализирует модуль: загружает настройки и подключает обработчик keydown.

Модальное окно создается динамически при первом открытии. Настройки сохраняются в localStorage под ключом `tradeSimHotkeys`.

## localStorage

Ключи, используемые для сохранения состояния:
- `tradeSimUseSl` - Состояние чекбокса Use S/L ('true' или 'false').
- `tradeSimEmulateSpread` - Состояние чекбокса Emulate spread ('true' или 'false').
- `tradeSimLeverage` - Значение селектора leverage (число в виде строки).
- `tradeSimHotkeys` - JSON-объект с пользовательскими горячими клавишами.
